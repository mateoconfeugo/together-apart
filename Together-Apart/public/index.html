<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-05-06 Sun 13:48 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>API Endpoints Development / Operations Doc for together-apart Project</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Matthew Burns" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://orgminimal.tizi.moe/bundle.min.css"/>
<script src="http://orgminimal.tizi.moe/bundle.min.js" type="text/javascript" ></script>
<link rel="stylesheet" type="text/css" href="./org.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">API Endpoints Development / Operations Doc for together-apart Project</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. Description</a></li>
<li><a href="#orgheadline4">2. Application Specification</a>
<ul>
<li><a href="#orgheadline2">2.1. General Requirements</a></li>
<li><a href="#orgheadline3">2.2. API Endpoint Function Requirements</a></li>
</ul>
</li>
<li><a href="#orgheadline5">3. Acceptance Criteria</a></li>
<li><a href="#orgheadline6">4. Usage</a></li>
<li><a href="#orgheadline7">5. Configuration</a></li>
<li><a href="#orgheadline8">6. Perl Dependencies</a></li>
<li><a href="#orgheadline9">7. Release</a></li>
<li><a href="#orgheadline20">8. Deployment</a>
<ul>
<li><a href="#orgheadline10">8.1. Create Debian Package</a></li>
<li><a href="#orgheadline11">8.2. Reverse Proxy Server</a></li>
<li><a href="#orgheadline13">8.3. SSL</a>
<ul>
<li><a href="#orgheadline12">8.3.1. starting secure server</a></li>
</ul>
</li>
<li><a href="#orgheadline14">8.4. built-in api devops endpoint</a></li>
<li><a href="#orgheadline15">8.5. restart</a></li>
<li><a href="#orgheadline19">8.6. Rolling Deployment</a>
<ul>
<li><a href="#orgheadline16">8.6.1. Start first version</a></li>
<li><a href="#orgheadline17">8.6.2. Start second version</a></li>
<li><a href="#orgheadline18">8.6.3. Kill the first version</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline29">9. Application  Logic</a>
<ul>
<li><a href="#orgheadline23">9.1. Basic Authentication using webservice</a>
<ul>
<li><a href="#orgheadline21">9.1.1. Code</a></li>
<li><a href="#orgheadline22">9.1.2. Test</a></li>
</ul>
</li>
<li><a href="#orgheadline25">9.2. API Interface</a>
<ul>
<li><a href="#orgheadline24">9.2.1. Error Codes</a></li>
</ul>
</li>
<li><a href="#orgheadline26">9.3. API Tests</a></li>
<li><a href="#orgheadline27">9.4. Access Management</a></li>
<li><a href="#orgheadline28">9.5. Application Code</a></li>
</ul>
</li>
<li><a href="#orgheadline30">10. Test Suite</a></li>
<li><a href="#orgheadline37">11. System Integration</a>
<ul>
<li><a href="#orgheadline32">11.1. SSL</a>
<ul>
<li><a href="#orgheadline31">11.1.1. Lets Encrypt - certbot</a></li>
</ul>
</li>
<li><a href="#orgheadline36">11.2. Systemd</a>
<ul>
<li><a href="#orgheadline33">11.2.1. hypnotoad</a></li>
<li><a href="#orgheadline34">11.2.2. Reload systemctl daemon</a></li>
<li><a href="#orgheadline35">11.2.3. rsyslog</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline44">12. Appendix A: TODO</a>
<ul>
<li><a href="#orgheadline42">12.1. Goals</a>
<ul>
<li><a href="#orgheadline38">12.1.1. manage technical debt (versioning, release, deploy, documentation, test)</a></li>
<li><a href="#orgheadline39">12.1.2. automatically maintain and update</a></li>
<li><a href="#orgheadline40">12.1.3. make it easy to run/work on the software</a></li>
<li><a href="#orgheadline41">12.1.4. checklists to help foster better development security practices</a></li>
</ul>
</li>
<li><a href="#orgheadline43">12.2. Design Tasks <code>[20/20]</code></a></li>
</ul>
</li>
<li><a href="#orgheadline45">13. Appendix B: System 3rd Party Dependencies/Requirements</a></li>
<li><a href="#orgheadline47">14. Appendix C: REPL /Debugger</a>
<ul>
<li><a href="#orgheadline46">14.1. Testing G7 - Setting up non sticky environment</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><span class="section-number-2">1</span> Description</h2>
<div class="outline-text-2" id="text-1">
<p>
This application provides a basic authenticated  REST like service dividing strings into odd and
even arrays and rejoining arrays into original strings.
</p>
</div>
</div>
<div id="outline-container-orgheadline4" class="outline-2">
<h2 id="orgheadline4"><span class="section-number-2">2</span> <a href="file:///home/mburns/Downloads/backend_coding_exercise.pdf">Application Specification</a></h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgheadline2" class="outline-3">
<h3 id="orgheadline2"><span class="section-number-3">2.1</span> General Requirements</h3>
<div class="outline-text-3" id="text-2-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Spec ID</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">G0</td>
<td class="org-left">Create valid credentials via register service <a href="https://interview-api.shiftboard.com/auth">https://interview-api.shiftboard.com/auth</a></td>
</tr>

<tr>
<td class="org-left">G1</td>
<td class="org-left">All requests must include basic auth.</td>
</tr>

<tr>
<td class="org-left">G2</td>
<td class="org-left">Validated against at auth service <a href="https://interview-api.shiftboard.com/auth">https://interview-api.shiftboard.com/auth</a>.</td>
</tr>

<tr>
<td class="org-left">G3</td>
<td class="org-left">Unsuccessful attempts return 401</td>
</tr>

<tr>
<td class="org-left">G4</td>
<td class="org-left">POSTs are a JSON formated object</td>
</tr>

<tr>
<td class="org-left">G5</td>
<td class="org-left">Required SHA1 posted content digest query parameter, signature, return 403 if  invalid</td>
</tr>

<tr>
<td class="org-left">G6</td>
<td class="org-left">Missing parameters return 422</td>
</tr>

<tr>
<td class="org-left">G7</td>
<td class="org-left">Operate in a non-sticky, load balanced environment.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">2.2</span> API Endpoint Function Requirements</h3>
<div class="outline-text-3" id="text-2-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Spec ID</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">F1</td>
<td class="org-left">Split string into even and odd character arrays, Assume first character 1, is odd.</td>
</tr>

<tr>
<td class="org-left">F2</td>
<td class="org-left">The user/pass will successfully authenticate against <a href="https://interview-api.shiftboard.com/auth">https://interview-api.shiftboard.com/auth</a>.</td>
</tr>

<tr>
<td class="org-left">F3</td>
<td class="org-left">Last result depending on method called last</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-2">
<h2 id="orgheadline5"><span class="section-number-2">3</span> Acceptance Criteria</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-sh">:curl -X POST -u USER:PASS <span style="color: #61CE3C;">\</span>
http://matt-burns.shftbrd.com/split?<span style="color: #D8FA3C;">signature</span>=04e74f3b8cfcf0b502ff701a9b5f0b98ece0d3b4 <span style="color: #61CE3C;">\</span>
-d <span style="color: #61CE3C;">'{"string":"split me"}'</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">curl -X POST -u USER:PASS <span style="color: #61CE3C;">\</span>
http://localhost/split?<span style="color: #D8FA3C;">signature</span>=04e74f3b8cfcf0b502ff701a9b5f0b98ece0d3b4 <span style="color: #61CE3C;">\</span>
-d <span style="color: #61CE3C;">'{"string":"split me"}'</span>
</pre>
</div>
<p>
{"message":{"odd":["s","l","t","m"],"even":["p","i"," ","e"]}}
</p>

<div class="org-src-container">

<pre class="src src-sh">curl -X POST -u USER:PASS <span style="color: #61CE3C;">\</span>
https://localhost/split?<span style="color: #D8FA3C;">signature</span>=04e74f3b8cfcf0b502ff701a9b5f0b98ece0d3b4 <span style="color: #61CE3C;">\</span>
-d <span style="color: #61CE3C;">'{"string":"split me"}'</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">curl -X POST -u USER:PASS <span style="color: #61CE3C;">\</span>
http://matt-burns.shftbrd.com/join?<span style="color: #D8FA3C;">signature</span>=6edd74450aa9206c4ba0b8c009de382a3e91f404 <span style="color: #61CE3C;">\</span>
-d <span style="color: #61CE3C;">'{"odd":["s","l","t","m"], "even":["p","i"," ","e"]}'</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">curl -X POST -u USER:PASS <span style="color: #61CE3C;">\</span>
http://localhost/join?<span style="color: #D8FA3C;">signature</span>=6edd74450aa9206c4ba0b8c009de382a3e91f404 <span style="color: #61CE3C;">\</span>
-d <span style="color: #61CE3C;">'{"odd":["s","l","t","m"], "even":["p","i"," ","e"]}'</span>
</pre>
</div>
<p>
{"message":"split me"}
</p>

<div class="org-src-container">

<pre class="src src-sh">curl -X POST -u USER:PASS <span style="color: #61CE3C;">\</span>
https://localhost:join?<span style="color: #D8FA3C;">signature</span>=6edd74450aa9206c4ba0b8c009de382a3e91f404 <span style="color: #61CE3C;">\</span>
-d <span style="color: #61CE3C;">'{"odd":["s","l","t","m"], "even":["p","i"," ","e"]}'</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">curl -u USER:PASS http://matt-burns.shftbrd.com/lastResponse
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">curl -u USER:PASS http://localhost/lastResponse
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">curl -u USER:PASS https://localhost/lastResponse
</pre>
</div>


<div class="org-src-container">

<pre class="src src-sh">prove -v -I/../Together-Apart/lib t/acceptance.t
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">Subtest: business unit tests.</span>
    1..3
    ok 1 - Odd and even combined into a single numberical sequence
    ok 2 - Numbers split into two sequences these the odd
    ok 3 - Numbers split into two sequence these are the even
ok 1 - business unit tests.
<span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">Subtest: API usage mocking registered auth. see F1, F2, F3, G0, G1, G2, G3, G4, G5, G6</span>
    1..10
    ok 1 - POST http://TBD:TBD@127.0.0.1:35837/split?<span style="color: #D8FA3C;">signature</span>=%3AjQ%C2%BF%C3%87%16%C3%A3j7%C3%A7%19_V%C2%8A%C3%B7u%27%3Fm%22
    ok 2 - 200 OK
    ok 3 - POST http://TBD:TBD@127.0.0.1:35837/split?<span style="color: #D8FA3C;">signature</span>=%3AjQ%C2%BF%C3%87%16%C3%A3j7%C3%A7%19_V%C2%8A%C3%B7u%27%3Fm%22
    ok 4 - 422 Unprocessable Entity
    ok 5 - POST http://TBD:TBD@127.0.0.1:35837/join?<span style="color: #D8FA3C;">signature</span>=%C2%B6D%C3%85%18%3B5%C3%8E%C2%86%0B%0Ef%C3%8D%04%5C%126%C3%94%05%C2%A5%C3%90
    ok 6 - 200 OK
    ok 7 - POST http://TBD:TBD@127.0.0.1:35837/join?<span style="color: #D8FA3C;">signature</span>=%C2%B6D%C3%85%18%3B5%C3%8E%C2%86%0B%0Ef%C3%8D%04%5C%126%C3%94%05%C2%A5%C3%90
    ok 8 - 422 Unprocessable Entity
    ok 9 - GET http://TBD:TBD@127.0.0.1:35837/lastResponse
    ok 10 - Basic auth check on each endpoint called the mock auth webservice
ok 2 - API usage mocking registered auth. see F1, F2, F3, G0, G1, G2, G3, G4, G5, G6
1..2
ok
All tests successful.
<span style="color: #D8FA3C;">Files</span>=1, <span style="color: #D8FA3C;">Tests</span>=2,  0 wallclock secs ( 0.02 usr  0.00 sys +  0.20 cusr  0.02 csys =  0.24 CPU)
Result: PASS
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6"><span class="section-number-2">4</span> Usage</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock1"><span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">run</span> {
    app-&gt;secrets([<span style="color: #61CE3C;">'DeletedCodeIsDebuggedCode'</span>]);
    app-&gt;log-&gt;info(<span style="color: #61CE3C;">"starting"</span>);
    app-&gt;start;
}

run() <span style="color: #FBDE2D; font-weight: bold;">unless</span> caller();
1;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline7" class="outline-2">
<h2 id="orgheadline7"><span class="section-number-2">5</span> Configuration</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock2">{
 auth_url =&gt; <span style="color: #61CE3C;">'https://interview-api.shiftboard.com/auth'</span>,
 name =&gt; <span style="color: #61CE3C;">'together_apart'</span>,
 register_url =&gt; <span style="color: #61CE3C;">'https://interview-api.shiftboard.com/register'</span>,
 public=&gt; <span style="color: #61CE3C;">"/home/mburns/projects/bb/shiftboard/docs"</span>,

 hypnotoad =&gt; {
   pidfile=&gt;<span style="color: #61CE3C;">"~/together-apart/script/hypnotoad.pid"</span>,
   listen  =&gt; [<span style="color: #61CE3C;">'http://*:80'</span>, <span style="color: #61CE3C;">'https://*:443?cert=/etc/server.crt&amp;key=/etc/server.key'</span>],
   workers =&gt; 10
  }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline8" class="outline-2">
<h2 id="orgheadline8"><span class="section-number-2">6</span> Perl Dependencies</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock3"><span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">strict</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">warnings</span>;

<span style="color: #FBDE2D; font-weight: bold;">package</span> <span style="color: #ff1493;">Together</span>::Apart;

<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Digest</span>::SHA qw<span style="color: #61CE3C;">(sha1)</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">List</span>::MoreUtils qw<span style="color: #61CE3C;">(zip)</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::Asset::File;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojolicious</span>::Lite;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::Base <span style="color: #61CE3C;">"Mojolicious"</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojolicious</span>::Static;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::URL;

plugin <span style="color: #61CE3C;">'Config'</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline9" class="outline-2">
<h2 id="orgheadline9"><span class="section-number-2">7</span> Release</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-sh">git push origin release-next
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline20" class="outline-2">
<h2 id="orgheadline20"><span class="section-number-2">8</span> Deployment</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-sh">git pull origin master
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">sudo perl -I./lib lib/Together/Apart.pm daemon -l http://[::]:80
</pre>
</div>
</div>
<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="orgheadline10"><span class="section-number-3">8.1</span> Create Debian Package</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">

<pre class="src src-sh">dzil clean &amp;&amp; dzil build
dh-make-perl make  Together-Apart/Together-Apart-0.01
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">dpkg together-apart --pre-invoke test-features-absent --post-invoke test-features-present --status-fd ./current-status --build ../dist/
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline11" class="outline-3">
<h3 id="orgheadline11"><span class="section-number-3">8.2</span> Reverse Proxy Server</h3>
<div class="outline-text-3" id="text-8-2">
<p>
In front of app acting as the endpoint accessible by external clients.
</p>
<ul class="org-ul">
<li>terminating SSL connections from the outside,</li>
<li>limits the number of concurrent open sockets towards the app</li>
<li>balancing load across multiple instances,</li>
<li>supporting several applications through the same IP/port.</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline13" class="outline-3">
<h3 id="orgheadline13"><span class="section-number-3">8.3</span> SSL</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock4"> hypnotoad =&gt; {
    listen  =&gt; [<span style="color: #61CE3C;">'https://*:443?cert=/etc/server.crt&amp;key=/etc/server.key'</span>],
    proxy   =&gt; 1,
    workers =&gt; 10
  }
</pre>
</div>
</div>
<div id="outline-container-orgheadline12" class="outline-4">
<h4 id="orgheadline12"><span class="section-number-4">8.3.1</span> starting secure server</h4>
<div class="outline-text-4" id="text-8-3-1">
<div class="org-src-container">

<pre class="src src-sh">$ ./script/together_apart daemon -l https://[::]:443
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline14" class="outline-3">
<h3 id="orgheadline14"><span class="section-number-3">8.4</span> built-in api devops endpoint</h3>
<div class="outline-text-3" id="text-8-4">
<p>
Target for github app repo release hook trigger post. Existing running version of the application
sets up and restarts public facing webserver proxying with updated symbolic links for
the site-availabe and sites-enabled point to the next blue green service pair in the the versioned
deployment release chain.
</p>
</div>
</div>
<div id="outline-container-orgheadline15" class="outline-3">
<h3 id="orgheadline15"><span class="section-number-3">8.5</span> restart</h3>
<div class="outline-text-3" id="text-8-5">
<div class="org-src-container">

<pre class="src src-sh">hypnotoad ./script/together_apart
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline19" class="outline-3">
<h3 id="orgheadline19"><span class="section-number-3">8.6</span> Rolling Deployment</h3>
<div class="outline-text-3" id="text-8-6">
</div><div id="outline-container-orgheadline16" class="outline-4">
<h4 id="orgheadline16"><span class="section-number-4">8.6.1</span> Start first version</h4>
<div class="outline-text-4" id="text-8-6-1">
<div class="org-src-container">

<pre class="src src-sh">./script/together_apart prefork -P /tmp/first.pid -l http://*:3000?<span style="color: #D8FA3C;">reuse</span>=1
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline17" class="outline-4">
<h4 id="orgheadline17"><span class="section-number-4">8.6.2</span> Start second version</h4>
<div class="outline-text-4" id="text-8-6-2">
<div class="org-src-container">

<pre class="src src-sh">./script/together_apart prefork -P /tmp/second.pid -l http://*:3000?<span style="color: #D8FA3C;">reuse</span>=1
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline18" class="outline-4">
<h4 id="orgheadline18"><span class="section-number-4">8.6.3</span> Kill the first version</h4>
<div class="outline-text-4" id="text-8-6-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #FF6400;">kill</span> -s TERM <span style="color: #fa8072;">`cat /tmp/first.pid`</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline29" class="outline-2">
<h2 id="orgheadline29"><span class="section-number-2">9</span> Application  Logic</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock5"><span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">together</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> ($<span style="color: #D8FA3C;">odd</span>, $<span style="color: #D8FA3C;">even</span>) = @<span style="color: #D8FA3C;">_</span>;
    <span style="color: #FBDE2D; font-weight: bold;">return</span> undef
        <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">odd</span> &amp;&amp; $<span style="color: #D8FA3C;">even</span>;
    <span style="color: #FBDE2D; font-weight: bold;">return</span> undef
        <span style="color: #FBDE2D; font-weight: bold;">unless</span> (scalar @$<span style="color: #D8FA3C;">odd</span> &gt; 0 &amp;&amp; scalar @$<span style="color: #D8FA3C;">even</span> &gt; 0);
    <span style="color: #FBDE2D; font-weight: bold;">return</span> join <span style="color: #61CE3C;">''</span>, zip(@$<span style="color: #D8FA3C;">odd</span>, @$<span style="color: #D8FA3C;">even</span>);
}
</pre>
</div>

<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock6"><span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">apart</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> @<span style="color: #D8FA3C;">array</span> = split(<span style="color: #61CE3C;">''</span>, $<span style="color: #D8FA3C;">_</span>[0]);
    <span style="color: #FBDE2D; font-weight: bold;">return</span> undef
        <span style="color: #FBDE2D; font-weight: bold;">unless</span> scalar @<span style="color: #D8FA3C;">array</span> &gt; 0;
    <span style="color: #8B8989; font-style: italic;"># bitwise AND array position select odd</span>
    <span style="color: #D8FA3C; font-weight: bold;">my</span> @<span style="color: #D8FA3C;">odd</span> = map {<span style="color: #61CE3C;">"$_"</span>} @<span style="color: #D8FA3C;">array</span>[grep {!($<span style="color: #D8FA3C;">_</span> &amp; 1)} 0..$#<span style="color: #D8FA3C;">array</span>];
    <span style="color: #8B8989; font-style: italic;"># invert logic to take even</span>
    <span style="color: #D8FA3C; font-weight: bold;">my</span> @<span style="color: #D8FA3C;">even</span> = map {<span style="color: #61CE3C;">"$_"</span>} @<span style="color: #D8FA3C;">array</span>[grep {($<span style="color: #D8FA3C;">_</span> &amp; 1)} 0..$#<span style="color: #D8FA3C;">array</span>];
    <span style="color: #FBDE2D; font-weight: bold;">return</span> {even =&gt; \@<span style="color: #D8FA3C;">even</span>, odd =&gt; \@<span style="color: #D8FA3C;">odd</span>};
}
</pre>
</div>


<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock7">    post <span style="color: #61CE3C;">'/join'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
        <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span>  = shift;
        <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">odd</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{odd};
        <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">even</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{even};
        <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter required"</span>}, status=&gt;422)
            <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">odd</span> &amp;&amp; $<span style="color: #D8FA3C;">even</span>;
        <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">joined</span> = together($<span style="color: #D8FA3C;">odd</span>, $<span style="color: #D8FA3C;">even</span>);
        $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>}=$<span style="color: #D8FA3C;">joined</span>;
        <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">joined</span>}, status=&gt;200);
    };
</pre>
</div>


<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock8">    post <span style="color: #61CE3C;">'/split'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
        <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span>  = shift;
        <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">split</span> = apart($<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{string}) || undef;
        <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter Invalid"</span>}, status=&gt;422)
            <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">split</span>;
        $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>} = $<span style="color: #D8FA3C;">split</span>;
        <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">split</span>}, status=&gt;200);
    };
</pre>
</div>

<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock9">get <span style="color: #61CE3C;">'/lastResponse'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">last</span> = $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>};
    <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">last</span>}, status=&gt;200);
};
</pre>
</div>
</div>
<div id="outline-container-orgheadline23" class="outline-3">
<h3 id="orgheadline23"><span class="section-number-3">9.1</span> Basic Authentication using webservice</h3>
<div class="outline-text-3" id="text-9-1">
</div><div id="outline-container-orgheadline21" class="outline-4">
<h4 id="orgheadline21"><span class="section-number-4">9.1.1</span> Code</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock10"><span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">check_credentials</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
    <span style="color: #D8FA3C; font-weight: bold;">my</span> ($<span style="color: #D8FA3C;">username</span>, $<span style="color: #D8FA3C;">password</span>) = split(<span style="color: #61CE3C;">':'</span>,  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;url-&gt;to_abs-&gt;userinfo)
        <span style="color: #FBDE2D; font-weight: bold;">if</span> $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;url-&gt;to_abs-&gt;userinfo;
    $<span style="color: #D8FA3C;">c</span>-&gt;ua-&gt;get(Mojo::URL-&gt;new($<span style="color: #D8FA3C;">ENV</span>{<span style="color: #61CE3C;">"auth_url"</span>} || app-&gt;config(<span style="color: #61CE3C;">'auth_url'</span>))
                -&gt;query({username=&gt;$<span style="color: #D8FA3C;">username</span>, password=&gt;$<span style="color: #D8FA3C;">password</span>})
                =&gt; {Accept=&gt;<span style="color: #61CE3C;">'application/json'</span>})-&gt;res == 200
                ? <span style="color: #FBDE2D; font-weight: bold;">return</span> 1
                : <span style="color: #FBDE2D; font-weight: bold;">return</span> 0;
}

<span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">check_signature</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> ($<span style="color: #D8FA3C;">signature</span>, $<span style="color: #D8FA3C;">string</span>) = @<span style="color: #D8FA3C;">_</span>;
    $<span style="color: #D8FA3C;">signature</span> &amp;&amp; $<span style="color: #D8FA3C;">string</span> &amp;&amp; ($<span style="color: #D8FA3C;">signature</span> eq sha1($<span style="color: #D8FA3C;">string</span>))
        ? <span style="color: #FBDE2D; font-weight: bold;">return</span> 1
        : <span style="color: #FBDE2D; font-weight: bold;">return</span> 0;
}

under(<span style="color: #FBDE2D; font-weight: bold;">sub</span> {<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift; <span style="color: #8B8989; font-style: italic;"># Basic Authentication for each request</span>
           $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Invalid"</span>}, status=&gt;401)
               <span style="color: #FBDE2D; font-weight: bold;">unless</span> check_credentials $<span style="color: #D8FA3C;">c</span>
      });
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline22" class="outline-4">
<h4 id="orgheadline22"><span class="section-number-4">9.1.2</span> Test</h4>
<div class="outline-text-4" id="text-9-1-2">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock11">subtest <span style="color: #61CE3C;">'testing registered authentication'</span> =&gt; <span style="color: #FBDE2D; font-weight: bold;">sub</span> {
    plan tests =&gt; 2;
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">module</span> = Test::MockModule-&gt;new(<span style="color: #61CE3C;">'Audition::WebService'</span>);
    $<span style="color: #D8FA3C;">module</span>-&gt;mock(<span style="color: #61CE3C;">'apart'</span>, <span style="color: #FBDE2D; font-weight: bold;">sub</span> { <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">desired_apart</span> });
    $<span style="color: #D8FA3C;">module</span>-&gt;mock(<span style="color: #61CE3C;">'together'</span>, <span style="color: #FBDE2D; font-weight: bold;">sub</span> { <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">desired_together</span> });
    Module::Name::subroutine(@<span style="color: #D8FA3C;">args</span>);
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/split'</span>);
    $<span style="color: #D8FA3C;">url</span>-&gt;query({signature =&gt; $<span style="color: #D8FA3C;">good_signature</span>});
    $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);
    $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/join'</span>);
    $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);
    $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/lastResult'</span>);
    $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);
};
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline25" class="outline-3">
<h3 id="orgheadline25"><span class="section-number-3">9.2</span> API Interface</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock12">        post <span style="color: #61CE3C;">'/split'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span>  = shift;
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">split</span> = apart($<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{string}) || undef;
            <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter Invalid"</span>}, status=&gt;422)
                <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">split</span>;
            $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>} = $<span style="color: #D8FA3C;">split</span>;
            <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">split</span>}, status=&gt;200);
        };
        post <span style="color: #61CE3C;">'/join'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span>  = shift;
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">odd</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{odd};
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">even</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{even};
            <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter required"</span>}, status=&gt;422)
                <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">odd</span> &amp;&amp; $<span style="color: #D8FA3C;">even</span>;
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">joined</span> = together($<span style="color: #D8FA3C;">odd</span>, $<span style="color: #D8FA3C;">even</span>);
            $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>}=$<span style="color: #D8FA3C;">joined</span>;
            <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">joined</span>}, status=&gt;200);
        };
</pre>
</div>
</div>
<div id="outline-container-orgheadline24" class="outline-4">
<h4 id="orgheadline24"><span class="section-number-4">9.2.1</span> Error Codes</h4>
<div class="outline-text-4" id="text-9-2-1">
<ul class="org-ul">
<li>G3 Application Functionality: return 401 on unsuccessful</li>
<li>G5 Application Functionality: return 403 on invalid sha1</li>
<li>G6 Application Functionality: return 422 on missing parameters</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgheadline26" class="outline-3">
<h3 id="orgheadline26"><span class="section-number-3">9.3</span> API Tests</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock13">    $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/join'</span>);
    $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/split'</span>);
    $<span style="color: #D8FA3C;">url</span>-&gt;query({signature =&gt; $<span style="color: #D8FA3C;">good_signature</span>});
    $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);
    $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/lastResult'</span>);
    $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline27" class="outline-3">
<h3 id="orgheadline27"><span class="section-number-3">9.4</span> Access Management</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock14">   under <span style="color: #FBDE2D; font-weight: bold;">sub</span> { <span style="color: #8B8989; font-style: italic;"># Valid API Requirement Assertions</span>
       <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
       <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">signature</span> = $<span style="color: #D8FA3C;">c</span>-&gt;param(<span style="color: #61CE3C;">'signature'</span>) || undef;
       <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">string</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{string} || undef;
       $<span style="color: #D8FA3C;">c</span> = $<span style="color: #D8FA3C;">c</span>-&gt;cookie(<span style="color: #61CE3C;">'together_apart'</span>=&gt;<span style="color: #61CE3C;">'last'</span>, {path=&gt;<span style="color: #61CE3C;">'/'</span>});
       <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter required)"</span>}, status=&gt;422)
           <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">string</span>;
       <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Checksum failure"</span>}, status=&gt;403)
           <span style="color: #FBDE2D; font-weight: bold;">unless</span> check_signature($<span style="color: #D8FA3C;">signature</span>, $<span style="color: #D8FA3C;">string</span>);

   };
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline28" class="outline-3">
<h3 id="orgheadline28"><span class="section-number-3">9.5</span> Application Code</h3>
<div class="outline-text-3" id="text-9-5">
<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock15"><span style="color: #8B8989; font-style: italic;">#</span><span style="color: #8B8989; font-style: italic;">ABSTRACT: split join api endpoints</span>
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">strict</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">warnings</span>;

<span style="color: #FBDE2D; font-weight: bold;">package</span> <span style="color: #ff1493;">Together</span>::Apart;

<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Digest</span>::SHA qw<span style="color: #61CE3C;">(sha1)</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">List</span>::MoreUtils qw<span style="color: #61CE3C;">(zip)</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::Asset::File;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojolicious</span>::Lite;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::Base <span style="color: #61CE3C;">"Mojolicious"</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojolicious</span>::Static;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::URL;

plugin <span style="color: #61CE3C;">'Config'</span>;

<span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">apart</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> @<span style="color: #D8FA3C;">array</span> = split(<span style="color: #61CE3C;">''</span>, $<span style="color: #D8FA3C;">_</span>[0]);
    <span style="color: #FBDE2D; font-weight: bold;">return</span> undef
        <span style="color: #FBDE2D; font-weight: bold;">unless</span> scalar @<span style="color: #D8FA3C;">array</span> &gt; 0;
    <span style="color: #8B8989; font-style: italic;"># bitwise AND array position select odd</span>
    <span style="color: #D8FA3C; font-weight: bold;">my</span> @<span style="color: #D8FA3C;">odd</span> = map {<span style="color: #61CE3C;">"$_"</span>} @<span style="color: #D8FA3C;">array</span>[grep {!($<span style="color: #D8FA3C;">_</span> &amp; 1)} 0..$#<span style="color: #D8FA3C;">array</span>];
    <span style="color: #8B8989; font-style: italic;"># invert logic to take even</span>
    <span style="color: #D8FA3C; font-weight: bold;">my</span> @<span style="color: #D8FA3C;">even</span> = map {<span style="color: #61CE3C;">"$_"</span>} @<span style="color: #D8FA3C;">array</span>[grep {($<span style="color: #D8FA3C;">_</span> &amp; 1)} 0..$#<span style="color: #D8FA3C;">array</span>];
    <span style="color: #FBDE2D; font-weight: bold;">return</span> {even =&gt; \@<span style="color: #D8FA3C;">even</span>, odd =&gt; \@<span style="color: #D8FA3C;">odd</span>};
}
<span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">together</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> ($<span style="color: #D8FA3C;">odd</span>, $<span style="color: #D8FA3C;">even</span>) = @<span style="color: #D8FA3C;">_</span>;
    <span style="color: #FBDE2D; font-weight: bold;">return</span> undef
        <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">odd</span> &amp;&amp; $<span style="color: #D8FA3C;">even</span>;
    <span style="color: #FBDE2D; font-weight: bold;">return</span> undef
        <span style="color: #FBDE2D; font-weight: bold;">unless</span> (scalar @$<span style="color: #D8FA3C;">odd</span> &gt; 0 &amp;&amp; scalar @$<span style="color: #D8FA3C;">even</span> &gt; 0);
    <span style="color: #FBDE2D; font-weight: bold;">return</span> join <span style="color: #61CE3C;">''</span>, zip(@$<span style="color: #D8FA3C;">odd</span>, @$<span style="color: #D8FA3C;">even</span>);
}
<span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">check_credentials</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
    <span style="color: #D8FA3C; font-weight: bold;">my</span> ($<span style="color: #D8FA3C;">username</span>, $<span style="color: #D8FA3C;">password</span>) = split(<span style="color: #61CE3C;">':'</span>,  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;url-&gt;to_abs-&gt;userinfo)
        <span style="color: #FBDE2D; font-weight: bold;">if</span> $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;url-&gt;to_abs-&gt;userinfo;
    $<span style="color: #D8FA3C;">c</span>-&gt;ua-&gt;get(Mojo::URL-&gt;new($<span style="color: #D8FA3C;">ENV</span>{<span style="color: #61CE3C;">"auth_url"</span>} || app-&gt;config(<span style="color: #61CE3C;">'auth_url'</span>))
                -&gt;query({username=&gt;$<span style="color: #D8FA3C;">username</span>, password=&gt;$<span style="color: #D8FA3C;">password</span>})
                =&gt; {Accept=&gt;<span style="color: #61CE3C;">'application/json'</span>})-&gt;res == 200
                ? <span style="color: #FBDE2D; font-weight: bold;">return</span> 1
                : <span style="color: #FBDE2D; font-weight: bold;">return</span> 0;
}

<span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">check_signature</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> ($<span style="color: #D8FA3C;">signature</span>, $<span style="color: #D8FA3C;">string</span>) = @<span style="color: #D8FA3C;">_</span>;
    $<span style="color: #D8FA3C;">signature</span> &amp;&amp; $<span style="color: #D8FA3C;">string</span> &amp;&amp; ($<span style="color: #D8FA3C;">signature</span> eq sha1($<span style="color: #D8FA3C;">string</span>))
        ? <span style="color: #FBDE2D; font-weight: bold;">return</span> 1
        : <span style="color: #FBDE2D; font-weight: bold;">return</span> 0;
}

under(<span style="color: #FBDE2D; font-weight: bold;">sub</span> {<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift; <span style="color: #8B8989; font-style: italic;"># Basic Authentication for each request</span>
           $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Invalid"</span>}, status=&gt;401)
               <span style="color: #FBDE2D; font-weight: bold;">unless</span> check_credentials $<span style="color: #D8FA3C;">c</span>
      });


group {
        under <span style="color: #FBDE2D; font-weight: bold;">sub</span> { <span style="color: #8B8989; font-style: italic;"># Valid API Requirement Assertions</span>
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">signature</span> = $<span style="color: #D8FA3C;">c</span>-&gt;param(<span style="color: #61CE3C;">'signature'</span>) || undef;
            <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">string</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{string} || undef;
            $<span style="color: #D8FA3C;">c</span> = $<span style="color: #D8FA3C;">c</span>-&gt;cookie(<span style="color: #61CE3C;">'together_apart'</span>=&gt;<span style="color: #61CE3C;">'last'</span>, {path=&gt;<span style="color: #61CE3C;">'/'</span>});
            <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter required)"</span>}, status=&gt;422)
                <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">string</span>;
            <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Checksum failure"</span>}, status=&gt;403)
                <span style="color: #FBDE2D; font-weight: bold;">unless</span> check_signature($<span style="color: #D8FA3C;">signature</span>, $<span style="color: #D8FA3C;">string</span>);

        };
            post <span style="color: #61CE3C;">'/split'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
                <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span>  = shift;
                <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">split</span> = apart($<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{string}) || undef;
                <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter Invalid"</span>}, status=&gt;422)
                    <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">split</span>;
                $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>} = $<span style="color: #D8FA3C;">split</span>;
                <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">split</span>}, status=&gt;200);
            };
            post <span style="color: #61CE3C;">'/join'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
                <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span>  = shift;
                <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">odd</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{odd};
                <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">even</span> =  $<span style="color: #D8FA3C;">c</span>-&gt;req-&gt;json-&gt;{even};
                <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;<span style="color: #61CE3C;">"Parameter required"</span>}, status=&gt;422)
                    <span style="color: #FBDE2D; font-weight: bold;">unless</span> $<span style="color: #D8FA3C;">odd</span> &amp;&amp; $<span style="color: #D8FA3C;">even</span>;
                <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">joined</span> = together($<span style="color: #D8FA3C;">odd</span>, $<span style="color: #D8FA3C;">even</span>);
                $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>}=$<span style="color: #D8FA3C;">joined</span>;
                <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">joined</span>}, status=&gt;200);
            };

};
get <span style="color: #61CE3C;">'/lastResponse'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">last</span> = $<span style="color: #D8FA3C;">c</span>-&gt;session-&gt;{<span style="color: #61CE3C;">'returned_last'</span>};
    <span style="color: #FBDE2D; font-weight: bold;">return</span> $<span style="color: #D8FA3C;">c</span>-&gt;render(json=&gt;{message=&gt;$<span style="color: #D8FA3C;">last</span>}, status=&gt;200);
};

get <span style="color: #61CE3C;">'/'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
    $<span style="color: #D8FA3C;">c</span>-&gt;res-&gt;headers-&gt;content_type(<span style="color: #61CE3C;">'text/html'</span>);
    $<span style="color: #D8FA3C;">c</span>-&gt;reply-&gt;asset(Mojo::Asset::File-&gt;new(path =&gt; <span style="color: #61CE3C;">'./public/index.html'</span>))
};

get <span style="color: #61CE3C;">'/org.css'</span>=&gt;<span style="color: #FBDE2D; font-weight: bold;">sub</span> {
    <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">c</span> = shift;
    $<span style="color: #D8FA3C;">c</span>-&gt;res-&gt;headers-&gt;content_type(<span style="color: #61CE3C;">'text/css'</span>);
    $<span style="color: #D8FA3C;">c</span>-&gt;reply-&gt;asset(Mojo::Asset::File-&gt;new(path =&gt; <span style="color: #61CE3C;">'./public/org.css'</span>));
};

<span style="color: #FBDE2D; font-weight: bold;">sub</span> <span style="color: #ff1493;">run</span> {
    app-&gt;secrets([<span style="color: #61CE3C;">'DeletedCodeIsDebuggedCode'</span>]);
    app-&gt;log-&gt;info(<span style="color: #61CE3C;">"starting"</span>);
    app-&gt;start;
}

run() <span style="color: #FBDE2D; font-weight: bold;">unless</span> caller();
1;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline30" class="outline-2">
<h2 id="orgheadline30"><span class="section-number-2">10</span> Test Suite</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">

<pre class="src src-sh">prove -v -I./lib t/acceptance.t
</pre>
</div>

<div class="org-src-container">

<pre class="src src-perl" id="orgsrcblock16"><span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Digest</span>::SHA  qw<span style="color: #61CE3C;">(sha1)</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Mojo</span>::JSON qw<span style="color: #61CE3C;">(decode_json encode_json)</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Test</span>::Mojo;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Test</span>::MockModule;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Test</span>::More;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">FindBin</span>;
<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">lib</span> <span style="color: #61CE3C;">"../lib"</span>;

<span style="color: #FBDE2D; font-weight: bold;">use</span> <span style="color: #4c83ff;">Together</span>::Apart;

<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">desired_together</span> = <span style="color: #61CE3C;">"split me"</span>;
<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">desired_apart</span> = {<span style="color: #61CE3C;">'odd'</span>  =&gt; [<span style="color: #61CE3C;">'s'</span>, <span style="color: #61CE3C;">'l'</span>, <span style="color: #61CE3C;">'t'</span>, <span style="color: #61CE3C;">'m'</span>],<span style="color: #61CE3C;">'even'</span>=&gt;[<span style="color: #61CE3C;">'p'</span>, <span style="color: #61CE3C;">'i'</span>, <span style="color: #61CE3C;">' '</span>, <span style="color: #61CE3C;">'e'</span>] };
<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">apart_got</span> = Together::Apart::apart($<span style="color: #D8FA3C;">desired_together</span>);
<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">got_together</span> = Together::Apart::together([<span style="color: #61CE3C;">'s'</span>, <span style="color: #61CE3C;">'l'</span>, <span style="color: #61CE3C;">'t'</span>, <span style="color: #61CE3C;">'m'</span>], [<span style="color: #61CE3C;">'p'</span>, <span style="color: #61CE3C;">'i'</span>, <span style="color: #61CE3C;">' '</span>, <span style="color: #61CE3C;">'e'</span>]);

subtest <span style="color: #61CE3C;">'business unit tests.'</span> =&gt; <span style="color: #FBDE2D; font-weight: bold;">sub</span> {
  plan tests =&gt; 3;
  is($<span style="color: #D8FA3C;">got_together</span>, $<span style="color: #D8FA3C;">desired_together</span>, <span style="color: #61CE3C;">'Odd and even combined into a single numberical sequence'</span>);
  is(@{$<span style="color: #D8FA3C;">apart_got</span>-&gt;{odd}}, @{[<span style="color: #61CE3C;">'s'</span>, <span style="color: #61CE3C;">'l'</span>, <span style="color: #61CE3C;">'t'</span>, <span style="color: #61CE3C;">'m'</span>]}, <span style="color: #61CE3C;">'Numbers split into two sequences these the odd'</span>);
  is(@{$<span style="color: #D8FA3C;">apart_got</span>-&gt;{even}}, @{[<span style="color: #61CE3C;">'p'</span>, <span style="color: #61CE3C;">'i'</span>, <span style="color: #61CE3C;">' '</span>, <span style="color: #61CE3C;">'e'</span>]}, <span style="color: #61CE3C;">'Numbers split into two sequence these are the even'</span>);
};

<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">t</span> = Test::Mojo-&gt;new;

subtest <span style="color: #61CE3C;">'API usage mocking registered auth. see F1, F2, F3, G0, G1, G2, G3, G4, G5, G6'</span> =&gt; <span style="color: #FBDE2D; font-weight: bold;">sub</span> {
  plan tests =&gt; 10;
  <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">auth_called</span> = 0;
  <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">register_called</span> = 0;
  <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">module</span> = Test::MockModule-&gt;new(<span style="color: #61CE3C;">'Together::Apart'</span>);
  $<span style="color: #D8FA3C;">module</span>-&gt;mock(<span style="color: #61CE3C;">'register'</span>, <span style="color: #FBDE2D; font-weight: bold;">sub</span> { $<span style="color: #D8FA3C;">register_called</span> += 1; <span style="color: #FBDE2D; font-weight: bold;">return</span> 1; });
  Together::Apart::register(@<span style="color: #D8FA3C;">args</span>);

  $<span style="color: #D8FA3C;">module</span>-&gt;mock(<span style="color: #61CE3C;">'check_credentials'</span>, <span style="color: #FBDE2D; font-weight: bold;">sub</span> { $<span style="color: #D8FA3C;">auth_called</span> += 1; <span style="color: #FBDE2D; font-weight: bold;">return</span> 1; });
  Together::Apart::check_credentials(@<span style="color: #D8FA3C;">args</span>);

  <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">test_data</span> = {<span style="color: #61CE3C;">'string'</span>=&gt;$<span style="color: #D8FA3C;">desired_together</span>};
  <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">good_signature</span> = sha1($<span style="color: #D8FA3C;">desired_together</span>);

  <span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/split'</span>);
  $<span style="color: #D8FA3C;">url</span>-&gt;query({signature =&gt; $<span style="color: #D8FA3C;">good_signature</span>});
  $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">test_data</span>)-&gt;status_is(200);

  $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/split'</span>);
  $<span style="color: #D8FA3C;">url</span>-&gt;query({signature =&gt; $<span style="color: #D8FA3C;">good_signature</span>});
  $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;{<span style="color: #61CE3C;">'bad_string'</span>=&gt;<span style="color: #61CE3C;">'bad'</span>})-&gt;status_is(422);

  $<span style="color: #D8FA3C;">good_signature</span> = sha1($<span style="color: #D8FA3C;">desired_apart</span>);
  $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/join'</span>);
  $<span style="color: #D8FA3C;">url</span>-&gt;query({signature =&gt; $<span style="color: #D8FA3C;">good_signature</span>});
  $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt;$<span style="color: #D8FA3C;">desired_apart</span>)-&gt;status_is(200);

  $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/join'</span>);
  $<span style="color: #D8FA3C;">url</span>-&gt;query({signature =&gt; $<span style="color: #D8FA3C;">good_signature</span>});
  $<span style="color: #D8FA3C;">t</span>-&gt;post_ok($<span style="color: #D8FA3C;">url</span>=&gt;json=&gt; {<span style="color: #61CE3C;">'odd'</span>=&gt;undef, <span style="color: #61CE3C;">'even'</span>=&gt;undef})-&gt;status_is(422);

  $<span style="color: #D8FA3C;">url</span> = $<span style="color: #D8FA3C;">t</span>-&gt;ua-&gt;server-&gt;url-&gt;userinfo(<span style="color: #61CE3C;">'TBD:TBD'</span>)-&gt;path(<span style="color: #61CE3C;">'/lastResponse'</span>);
  $<span style="color: #D8FA3C;">t</span>-&gt;get_ok($<span style="color: #D8FA3C;">url</span>);
  is($<span style="color: #D8FA3C;">auth_called</span>, 6, <span style="color: #61CE3C;">'Basic auth check on each endpoint called the mock auth webservice'</span>);
};

done_testing();
1;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline37" class="outline-2">
<h2 id="orgheadline37"><span class="section-number-2">11</span> System Integration</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-orgheadline32" class="outline-3">
<h3 id="orgheadline32"><span class="section-number-3">11.1</span> SSL</h3>
<div class="outline-text-3" id="text-11-1">
</div><div id="outline-container-orgheadline31" class="outline-4">
<h4 id="orgheadline31"><span class="section-number-4">11.1.1</span> Lets Encrypt - certbot</h4>
<div class="outline-text-4" id="text-11-1-1">
<div class="org-src-container">

<pre class="src src-sh">$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo add-apt-repository ppa:certbot/certbot
$ sudo apt-get update
$ sudo apt-get install python-certbot-apache
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline36" class="outline-3">
<h3 id="orgheadline36"><span class="section-number-3">11.2</span> Systemd</h3>
<div class="outline-text-3" id="text-11-2">
</div><div id="outline-container-orgheadline33" class="outline-4">
<h4 id="orgheadline33"><span class="section-number-4">11.2.1</span> hypnotoad</h4>
<div class="outline-text-4" id="text-11-2-1">
<div class="org-src-container">

<pre class="src src-sh">[Unit]
<span style="color: #D8FA3C;">Description</span>=together-apart application
<span style="color: #D8FA3C;">Requires</span>=network.target
<span style="color: #D8FA3C;">After</span>=network.target

[Service]
<span style="color: #D8FA3C;">Type</span>=forking
<span style="color: #D8FA3C;">PIDFile</span>=/home/ubuntu/together-apart/script/hypnotoad.pid
<span style="color: #D8FA3C;">ExecStart</span>=/usr/bin/hypnotoad /home/ubuntu/together-apart/script/together_apart -f
<span style="color: #D8FA3C;">ExecStop</span>=/usr/bin/hypnotoad -s  /home/ubuntu/together-apart/script/together_apart
<span style="color: #D8FA3C;">ExecReload</span>=/usr/bin/hypnotoad /home/ubuntu/together-apart/script/together_apart
<span style="color: #D8FA3C;">KillMode</span>=process

[Install]
<span style="color: #D8FA3C;">WantedBy</span>=multi-user.target
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline34" class="outline-4">
<h4 id="orgheadline34"><span class="section-number-4">11.2.2</span> Reload systemctl daemon</h4>
<div class="outline-text-4" id="text-11-2-2">
<div class="org-src-container">

<pre class="src src-sh">sudo systemctl --system daemon-reload
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline35" class="outline-4">
<h4 id="orgheadline35"><span class="section-number-4">11.2.3</span> rsyslog</h4>
<div class="outline-text-4" id="text-11-2-3">
<div class="org-src-container">

<pre class="src src-ini">if $programname == '* Packages
</pre>
</div>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install libmojolicious-perl  libdigest-sha-perl liblist-moreutils-perl libtry-tiny-perl
</pre>
</div>

<div class="org-src-container">

<pre class="src src-:mkdir">name    = Together-Apart
         version = 0.01
         author  = matthewburns@gmail
         license = MIT
         copyright_holder = Matt Burns

[@Basic]

[Prereqs]

Mojolicious     = 7.77
Digest::SHA      = 6.02
List::MoreUtils  = 0.428

[Control::Debian]
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline44" class="outline-2">
<h2 id="orgheadline44"><span class="section-number-2">12</span> Appendix A: TODO</h2>
<div class="outline-text-2" id="text-12">
<p>
org-mode to document and automate microservice development,  operational and maintainence tasks.
API provides access to the app code block creating devop playbooks.
</p>

<p>
Application update endpoint targeted by github repo webhooks triggered merge into master,
creates continous delivery feedback loop used deploying new version, handing off
the request handling of the service to the new version.
</p>

<p>
Debian packages and socket reuse make upgrade to new version while system is running in production.
push system based on ssh and public/private key access.
</p>
</div>
<div id="outline-container-orgheadline42" class="outline-3">
<h3 id="orgheadline42"><span class="section-number-3">12.1</span> Goals</h3>
<div class="outline-text-3" id="text-12-1">
</div><div id="outline-container-orgheadline38" class="outline-4">
<h4 id="orgheadline38"><span class="section-number-4">12.1.1</span> manage technical debt (versioning, release, deploy, documentation, test)</h4>
</div>
<div id="outline-container-orgheadline39" class="outline-4">
<h4 id="orgheadline39"><span class="section-number-4">12.1.2</span> automatically maintain and update</h4>
</div>
<div id="outline-container-orgheadline40" class="outline-4">
<h4 id="orgheadline40"><span class="section-number-4">12.1.3</span> make it easy to run/work on the software</h4>
</div>
<div id="outline-container-orgheadline41" class="outline-4">
<h4 id="orgheadline41"><span class="section-number-4">12.1.4</span> checklists to help foster better development security practices</h4>
</div>
</div>
<div id="outline-container-orgheadline43" class="outline-3">
<h3 id="orgheadline43"><span class="section-number-3">12.2</span> Design Tasks <code>[20/20]</code></h3>
<div class="outline-text-3" id="text-12-2">
<ul class="org-ul">
<li class="on"><code>[X]</code> Publishes code into source files</li>
<li class="on"><code>[X]</code> Releases the code into the upstream code repository</li>
<li class="on"><code>[X]</code> Deploys the code onto the desired runtime platorm (dev, qa, stg, prd)</li>
<li class="on"><code>[X]</code> Provisions the runtime infrastructure and like artifacts the application is dependent upon.</li>
<li class="on"><code>[X]</code> Capture the functional requirements in automated testable form</li>
<li class="on"><code>[X]</code> Understand engineering decisions behind the implementation, design, methodology testing</li>
<li class="on"><code>[X]</code> Define the way features are deployed into new versions of this WebService</li>
<li class="on"><code>[X]</code> Run tests</li>
<li class="on"><code>[X]</code> Provides application documentation</li>
<li class="on"><code>[X]</code> Provide development history</li>
<li class="on"><code>[X]</code> Provides a reduamentry cli interface to devops/maintence tasks</li>
<li class="on"><code>[X]</code> Sets up and runs system from src control repo (github)</li>
<li class="on"><code>[X]</code> Provide  way to refer and collaborate among developers</li>
<li class="on"><code>[X]</code> Continous Delivery</li>
<li class="on"><code>[X]</code> Worksheet to aid in project management aspects of software development</li>
<li class="on"><code>[X]</code> Bridge that first draft proof of concept devops task into part of the crm/orchestration process</li>
<li class="on"><code>[X]</code> Allows the stitching together of many pre- [-]existing tools (git, dpkg,</li>
<li class="on"><code>[X]</code> Incorporate others work via pull requests.</li>
<li class="on"><code>[X]</code> Define Idioms</li>
<li class="on"><code>[X]</code> Capture domain specific paculiarities</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgheadline45" class="outline-2">
<h2 id="orgheadline45"><span class="section-number-2">13</span> Appendix B: System 3rd Party Dependencies/Requirements</h2>
<div class="outline-text-2" id="text-13">
<ul class="org-ul">
<li>Local: Running in the context of a ordinary linux system account</li>
<li>API web application</li>
<li>Common library components</li>
<li>Github hooks to deploy</li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline47" class="outline-2">
<h2 id="orgheadline47"><span class="section-number-2">14</span> Appendix C: REPL /Debugger</h2>
<div class="outline-text-2" id="text-14">
<div class="org-src-container">

<pre class="src src-sh">perl -d -I../lib  Together-Apart/lib/Together/Apart.pm daemon
</pre>
</div>
</div>
<div id="outline-container-orgheadline46" class="outline-3">
<h3 id="orgheadline46"><span class="section-number-3">14.1</span> Testing G7 - Setting up non sticky environment</h3>
<div class="outline-text-3" id="text-14-1">
<div class="org-src-container">

<pre class="src src-perl"><span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">Listen on two ports with HTTP and HTTPS at the same time</span>
$<span style="color: #D8FA3C;">daemon</span>-&gt;listen([<span style="color: #61CE3C;">'http://*:3000'</span>, <span style="color: #61CE3C;">'https://*:4000'</span>]);
<span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">Listen on release-next port</span>
<span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">4461 release-next -&gt; new version</span>
<span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">4460 master -&gt; existing prd version</span>
<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">port</span> = $<span style="color: #D8FA3C;">daemon</span>-&gt;listen([<span style="color: #61CE3C;">'http://127.0.0.1'</span>])-&gt;start-&gt;ports-&gt;[0];
<span style="color: #8B8989; font-style: italic;"># </span><span style="color: #8B8989; font-style: italic;">Run multiple web servers concurrently</span>
<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">daemon1</span> = Mojo::Server::Daemon-&gt;new(listen =&gt; [<span style="color: #61CE3C;">'http://*:3000'</span>])-&gt;start;
<span style="color: #D8FA3C; font-weight: bold;">my</span> $<span style="color: #D8FA3C;">daemon2</span> = Mojo::Server::Daemon-&gt;new(listen =&gt; [<span style="color: #61CE3C;">'http://*:4000'</span>])-&gt;start;
Mojo::IOLoop-&gt;start <span style="color: #FBDE2D; font-weight: bold;">unless</span> Mojo::IOLoop-&gt;is_running;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: <span class="timestamp-wrapper"><span class="timestamp">&lt;2018-05-01 Tue&gt;</span></span></p>
<p class="author">Author: Matthew Burns</p>
<p class="date">Created: 2018-05-06 Sun 13:48</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
